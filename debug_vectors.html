<!DOCTYPE html>
<html>
<head>
    <title>Vector Layer Debug</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; font-family: Arial; }
        #container { display: flex; height: 100vh; }
        #sidebar { width: 300px; padding: 20px; background: #f5f5f5; overflow-y: auto; }
        #map { flex: 1; position: relative; }
        button { padding: 10px; margin: 5px; width: 100%; }
        #debug { background: #fff; padding: 10px; margin: 10px 0; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div id="container">
        <div id="sidebar">
            <h1>Vector Layer Debug</h1>

            <button onclick="testAPI()">Test API</button>
            <button onclick="loadProtectedAreas()">Load Protected Areas</button>
            <button onclick="loadShippingRoutes()">Load Shipping Routes</button>
            <button onclick="clearAll()">Clear All</button>

            <div id="debug">
                <h3>Debug Info:</h3>
                <div id="debugOutput">Click buttons to test...</div>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <script>
        const map = L.map('map').setView([54.0, 10.0], 4);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}').addTo(map);

        let vectorLayer = null;

        function log(message) {
            const output = document.getElementById('debugOutput');
            output.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            console.log(message);
        }

        function testAPI() {
            log('Testing vector layers API...');
            fetch('/api/vector/layers')
                .then(r => r.json())
                .then(data => {
                    log('API Response: ' + JSON.stringify(data, null, 2));
                })
                .catch(err => {
                    log('API Error: ' + err);
                });
        }

        function loadProtectedAreas() {
            log('Loading protected areas...');

            if (vectorLayer) {
                map.removeLayer(vectorLayer);
                vectorLayer = null;
            }

            fetch('/api/vector/layer/sample_marine_protected_areas')
                .then(r => r.json())
                .then(geojson => {
                    log('GeoJSON received: ' + JSON.stringify(geojson, null, 2));

                    vectorLayer = L.geoJSON(geojson, {
                        style: {
                            fillColor: '#ff7800',
                            weight: 2,
                            opacity: 1,
                            color: 'white',
                            dashArray: '3',
                            fillOpacity: 0.4
                        },
                        onEachFeature: function(feature, layer) {
                            if (feature.properties) {
                                let popupContent = '<div><b>Marine Protected Area</b><br>';
                                Object.keys(feature.properties).forEach(key => {
                                    popupContent += `<b>${key}:</b> ${feature.properties[key]}<br>`;
                                });
                                popupContent += '</div>';
                                layer.bindPopup(popupContent);
                            }
                        }
                    });

                    vectorLayer.addTo(map);
                    log('Vector layer added to map');

                    if (vectorLayer.getBounds().isValid()) {
                        map.fitBounds(vectorLayer.getBounds(), {padding: [20, 20]});
                        log('Map fitted to bounds: ' + JSON.stringify(vectorLayer.getBounds()));
                    } else {
                        log('Invalid bounds for vector layer');
                    }
                })
                .catch(err => {
                    log('Error loading protected areas: ' + err);
                });
        }

        function loadShippingRoutes() {
            log('Loading shipping routes...');

            if (vectorLayer) {
                map.removeLayer(vectorLayer);
                vectorLayer = null;
            }

            fetch('/api/vector/layer/sample_shipping_routes')
                .then(r => r.json())
                .then(geojson => {
                    log('Shipping routes GeoJSON: ' + JSON.stringify(geojson, null, 2));

                    vectorLayer = L.geoJSON(geojson, {
                        style: {
                            color: '#3388ff',
                            weight: 4,
                            opacity: 0.8
                        },
                        onEachFeature: function(feature, layer) {
                            if (feature.properties) {
                                let popupContent = '<div><b>Shipping Route</b><br>';
                                Object.keys(feature.properties).forEach(key => {
                                    popupContent += `<b>${key}:</b> ${feature.properties[key]}<br>`;
                                });
                                popupContent += '</div>';
                                layer.bindPopup(popupContent);
                            }
                        }
                    });

                    vectorLayer.addTo(map);
                    log('Shipping routes added to map');

                    if (vectorLayer.getBounds().isValid()) {
                        map.fitBounds(vectorLayer.getBounds(), {padding: [20, 20]});
                        log('Map fitted to shipping route bounds');
                    }
                })
                .catch(err => {
                    log('Error loading shipping routes: ' + err);
                });
        }

        function clearAll() {
            if (vectorLayer) {
                map.removeLayer(vectorLayer);
                vectorLayer = null;
                log('Vector layer cleared');
            }
            document.getElementById('debugOutput').innerHTML = 'Debug cleared<br>';
        }
    </script>
</body>
</html>