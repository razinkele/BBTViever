<!DOCTYPE html>
<html>
<head>
    <title>MARBEFES BBT Database</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- External CSS Dependencies -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

    <!-- External JavaScript Dependencies -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-geometryutil@0.10.1/src/leaflet.geometryutil.js"></script>

    <!-- PyDeck/Deck.gl Dependencies -->
    <script src="https://unpkg.com/deck.gl@^8.9.0/dist.min.js"></script>
    <script src="https://unpkg.com/@deck.gl/layers@^8.9.0/dist.min.js"></script>
    <script src="https://unpkg.com/@deck.gl/geo-layers@^8.9.0/dist.min.js"></script>
    <script src="https://unpkg.com/@deck.gl/aggregation-layers@^8.9.0/dist.min.js"></script>
</head>
<body>
    <div id="container">
        <div id="sidebar">
            <h1>
                <img src="{{ APPLICATION_ROOT }}/logo/marbefes_02.png" alt="MARBEFES Logo" class="logo">
                MARBEFES BBT Database
                <button class="help-button" onclick="showVersionInfo()" title="Version Information & Help">
                    <span class="help-icon-btn">‚ìò</span>
                </button>
            </h1>
            <div class="subtitle">Marine Biodiversity and Ecosystem Functioning leading to Ecosystem Services</div>

            <h3>BBT Quick Navigation</h3>
            <div class="bbt-nav-section">
                <div class="bbt-nav-buttons" id="bbt-nav-buttons">
                    <!-- Vertical left-aligned BBT buttons with data buttons -->
                    <div class="bbt-button-row">
                        <button class="bbt-nav-btn" onclick="zoomToBBTArea('Archipelago')" title="üó∫Ô∏è Zoom to Archipelago BBT area">Archipelago</button>
                        <button class="bbt-data-btn" onclick="openBBTDataPopup('Archipelago')" title="üìä View/Edit BBT Data">üìä</button>
                    </div>
                    <div class="bbt-button-row">
                        <button class="bbt-nav-btn" onclick="zoomToBBTArea('Balearic')" title="üó∫Ô∏è Zoom to Balearic BBT area">Balearic</button>
                        <button class="bbt-data-btn" onclick="openBBTDataPopup('Balearic')" title="üìä View/Edit BBT Data">üìä</button>
                    </div>
                    <div class="bbt-button-row">
                        <button class="bbt-nav-btn" onclick="zoomToBBTArea('Bay of Gdansk')" title="üó∫Ô∏è Zoom to Bay of Gdansk BBT area">Bay of Gdansk</button>
                        <button class="bbt-data-btn" onclick="openBBTDataPopup('Bay of Gdansk')" title="üìä View/Edit BBT Data">üìä</button>
                    </div>
                    <div class="bbt-button-row">
                        <button class="bbt-nav-btn" onclick="zoomToBBTArea('Gulf of Biscay')" title="üó∫Ô∏è Zoom to Gulf of Biscay BBT area">Gulf of Biscay</button>
                        <button class="bbt-data-btn" onclick="openBBTDataPopup('Gulf of Biscay')" title="üìä View/Edit BBT Data">üìä</button>
                    </div>
                    <div class="bbt-button-row">
                        <button class="bbt-nav-btn" onclick="zoomToBBTArea('Heraklion')" title="üó∫Ô∏è Zoom to Heraklion BBT area">Heraklion</button>
                        <button class="bbt-data-btn" onclick="openBBTDataPopup('Heraklion')" title="üìä View/Edit BBT Data">üìä</button>
                    </div>
                    <div class="bbt-button-row">
                        <button class="bbt-nav-btn" onclick="zoomToBBTArea('Hornsund')" title="üó∫Ô∏è Zoom to Hornsund BBT area">Hornsund</button>
                        <button class="bbt-data-btn" onclick="openBBTDataPopup('Hornsund')" title="üìä View/Edit BBT Data">üìä</button>
                    </div>
                    <div class="bbt-button-row">
                        <button class="bbt-nav-btn" onclick="zoomToBBTArea('Irish Sea')" title="üó∫Ô∏è Zoom to Irish Sea BBT area">Irish Sea</button>
                        <button class="bbt-data-btn" onclick="openBBTDataPopup('Irish Sea')" title="üìä View/Edit BBT Data">üìä</button>
                    </div>
                    <div class="bbt-button-row">
                        <button class="bbt-nav-btn" onclick="zoomToBBTArea('Kongsfjord')" title="üó∫Ô∏è Zoom to Kongsfjord BBT area">Kongsfjord</button>
                        <button class="bbt-data-btn" onclick="openBBTDataPopup('Kongsfjord')" title="üìä View/Edit BBT Data">üìä</button>
                    </div>
                    <div class="bbt-button-row">
                        <button class="bbt-nav-btn" onclick="zoomToBBTArea('Lithuanian coastal zone')" title="üó∫Ô∏è Zoom to Lithuanian coastal zone BBT area">Lithuanian coastal zone</button>
                        <button class="bbt-data-btn" onclick="openBBTDataPopup('Lithuanian coastal zone')" title="üìä View/Edit BBT Data">üìä</button>
                    </div>
                    <div class="bbt-button-row">
                        <button class="bbt-nav-btn" onclick="zoomToBBTArea('North Sea')" title="üó∫Ô∏è Zoom to North Sea BBT area">North Sea</button>
                        <button class="bbt-data-btn" onclick="openBBTDataPopup('North Sea')" title="üìä View/Edit BBT Data">üìä</button>
                    </div>
                    <div class="bbt-button-row">
                        <button class="bbt-nav-btn" onclick="zoomToBBTArea('Sardinia')" title="üó∫Ô∏è Zoom to Sardinia BBT area">Sardinia</button>
                        <button class="bbt-data-btn" onclick="openBBTDataPopup('Sardinia')" title="üìä View/Edit BBT Data">üìä</button>
                    </div>
                    <div class="loading-indicator" id="bbt-loading" style="color: #20B2AA; font-size: 10px; padding: 4px; text-align: center; margin-top: 8px; display: none;">
                        üîÑ Loading enhanced features...
                    </div>
                </div>
            </div>

            <!-- BBT Zoom Mode Toggle -->
            <div class="bbt-zoom-mode-section" style="margin-top: 12px; margin-bottom: 16px;">
                <h4 style="font-size: 12px; margin-bottom: 8px; color: #333;">BBT Zoom Mode:</h4>
                <div class="zoom-mode-toggle">
                    <button id="zoom-mode-detail" class="zoom-mode-btn active" onclick="setBBTZoomMode('detail')" title="Force zoom to specific level for optimal EUNIS layer visibility">
                        üî¨ Full Detail
                    </button>
                    <button id="zoom-mode-fit" class="zoom-mode-btn" onclick="setBBTZoomMode('fit')" title="Fit entire BBT area in view (may zoom out)">
                        üó∫Ô∏è Fit Bounds
                    </button>
                </div>

                <!-- Zoom Level Slider (for Full Detail mode) -->
                <div id="zoom-level-slider-container" style="margin-top: 10px;">
                    <label for="bbt-zoom-level" style="font-size: 11px; color: #555; display: block; margin-bottom: 4px;">
                        Detail Zoom Level: <span id="bbt-zoom-level-value" style="font-weight: 600; color: #20B2AA;">11</span>
                    </label>
                    <input type="range" id="bbt-zoom-level" min="5" max="15" value="11"
                           style="width: 100%; cursor: pointer;"
                           oninput="updateBBTZoomLevel(this.value)"
                           title="Adjust zoom level for Full Detail mode (5-15)">
                    <div style="display: flex; justify-content: space-between; font-size: 9px; color: #999; margin-top: 2px;">
                        <span>5 (Far)</span>
                        <span>10 (Medium)</span>
                        <span>15 (Close)</span>
                    </div>
                </div>

                <div style="font-size: 10px; color: #666; margin-top: 6px; line-height: 1.3;">
                    <span id="zoom-mode-description">
                        Full Detail: Always zoom to level 11 for optimal habitat layer visibility
                    </span>
                </div>
            </div>

            <h3>Available Layers</h3>

            <!-- EUNIS Legend Toggle -->
            <div class="control-group" style="margin-bottom: 15px;">
                <label for="eunis-legend-toggle" style="display: flex; align-items: center; cursor: pointer; font-size: 13px;">
                    <input type="checkbox" id="eunis-legend-toggle" style="margin-right: 8px; cursor: pointer;">
                    Show EUNIS 2019 Legend
                </label>
            </div>

            <!-- Collapsible EMODnet Overlay Section -->
            <div class="control-group">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-bottom: 8px;" onclick="toggleEmodnetPanel()">
                    <label for="layer-select" style="margin: 0; cursor: pointer; flex: 1;">Select EMODnet Overlay</label>
                    <span id="emodnet-status-tooltip" style="font-size: 11px; color: #666; margin: 0 8px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="">Loading...</span>
                    <span id="emodnet-toggle-icon" style="font-size: 16px; color: #20B2AA;">‚ñº</span>
                </div>
                <div id="emodnet-panel" style="display: block; margin-top: 0px;">
                    <select id="layer-select" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                    </select>
                </div>
            </div>

            <!-- Collapsible HELCOM Overlay Section -->
            <div class="control-group">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-bottom: 8px;" onclick="toggleHelcomPanel()">
                    <label for="helcom-select" style="margin: 0; cursor: pointer; flex: 1;">HELCOM Baltic Sea Overlay</label>
                    <span id="helcom-status-tooltip" style="font-size: 11px; color: #666; margin: 0 8px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="">No overlay</span>
                    <span id="helcom-toggle-icon" style="font-size: 16px; color: #20B2AA;">‚ñ∂</span>
                </div>
                <div id="helcom-panel" style="display: none; margin-top: 0px;">
                    <select id="helcom-select" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                    </select>
                </div>
            </div>

            <!-- Collapsible Advanced Controls Section -->
            <div class="control-group">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-bottom: 8px; margin-top: 15px;" onclick="toggleAdvancedPanel()">
                    <h3 style="margin: 0; cursor: pointer; flex: 1; font-size: 14px;">Advanced Controls</h3>
                    <span id="advanced-toggle-icon" style="font-size: 16px; color: #20B2AA;">‚ñ∂</span>
                </div>
            </div>

            <div id="advanced-panel" style="display: none;">
            <div class="controls">
                <div class="control-group">
                    <label for="opacity">Layer Opacity</label>
                    <input type="range" id="opacity" min="0" max="100" value="70">
                    <div class="value-display" id="opacity-value">70%</div>
                </div>

                <div class="control-group">
                    <label for="basemap">Base Map</label>
                    <select id="basemap" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="emodnet_bathymetry">EMODnet Bathymetry</option>
                        <option value="osm">OpenStreetMap</option>
                        <option value="satellite" selected>Satellite</option>
                        <option value="ocean">Ocean</option>
                        <option value="light">Light Gray</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="theme">UI Theme</label>
                    <select id="theme" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="ocean" selected>Ocean Blue</option>
                        <option value="forest">Forest Green</option>
                        <option value="sunset">Sunset Orange</option>
                        <option value="midnight">Midnight Dark</option>
                        <option value="arctic">Arctic White</option>
                    </select>
                </div>

                <!-- PyDeck 3D Visualization Controls -->
                <div class="control-group">
                    <h4 style="margin: 15px 0 10px 0; color: #2F4F4F; font-size: 14px; border-bottom: 1px solid #20B2AA; padding-bottom: 5px;">3D Visualization</h4>

                    <div style="margin-bottom: 10px;">
                        <label for="enable-3d">
                            <input type="checkbox" id="enable-3d" style="margin-right: 8px;">
                            Enable 3D View
                        </label>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <label for="pydeck-layer">PyDeck Layer Type</label>
                        <select id="pydeck-layer" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px;">
                            <option value="none">None</option>
                            <option value="hexagon">Hexagon Aggregation</option>
                            <option value="heatmap">Heatmap</option>
                            <option value="grid">Grid Layer</option>
                            <option value="contour">Contour Layer</option>
                            <option value="column">3D Column Chart</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <label for="elevation-scale">Elevation Scale</label>
                        <input type="range" id="elevation-scale" min="1" max="10000" value="1000" style="width: 100%;">
                        <div class="value-display" id="elevation-value">1000x</div>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <label for="radius-scale">Point Radius</label>
                        <input type="range" id="radius-scale" min="100" max="5000" value="1000" style="width: 100%;">
                        <div class="value-display" id="radius-value">1000m</div>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <label for="color-scheme">Color Scheme</label>
                        <select id="color-scheme" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px;">
                            <option value="viridis">Viridis (Blue-Green-Yellow)</option>
                            <option value="plasma">Plasma (Purple-Pink-Yellow)</option>
                            <option value="ocean">Ocean (Blue-Cyan-White)</option>
                            <option value="thermal">Thermal (Black-Red-Yellow)</option>
                            <option value="turbo">Turbo (Blue-Cyan-Green-Yellow-Red)</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <label for="view-mode">Camera View</label>
                        <select id="view-mode" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px;">
                            <option value="2d">2D (Top Down)</option>
                            <option value="3d">3D (Perspective)</option>
                            <option value="bird">Bird's Eye</option>
                            <option value="first-person">First Person</option>
                        </select>
                    </div>
                </div>
            </div>
            </div>

            <!-- Project Info moved to bottom -->
            <div class="project-info" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(32, 178, 170, 0.3);">
                <div class="project-links">
                    <a href="https://marbefes.eu" target="_blank" title="Visit MARBEFES Project Website">üåê marbefes.eu</a>
                    <a href="https://cordis.europa.eu/project/id/101060937" target="_blank" title="View on CORDIS">üìã CORDIS</a>
                    <a href="https://marbefes.lifewatch.eu" target="_blank" title="MARBEFES Toolbox">üîß Toolbox</a>
                </div>
                <div class="grant-info">
                    <small>Horizon Europe Grant Agreement No. 101060937</small>
                </div>
            </div>

            <div class="legend-container" id="legend-container" style="display: none;">
                <h4>Legend</h4>
                <img id="legend-image" src="" alt="Layer legend">
            </div>
        </div>

        <div id="map"></div>
        <div id="pydeck-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 400;"></div>
        <div class="status" id="status">Ready</div>
    </div>

    <!-- Floating EUNIS Legend -->
    <div class="floating-eunis-legend" id="floating-eunis-legend">
        <div class="floating-eunis-legend-header">
            <h4 class="floating-eunis-legend-title">üó∫Ô∏è EUNIS 2019 Habitat Legend</h4>
            <button class="floating-eunis-legend-close" onclick="closeEunisLegend()" title="Close legend">&times;</button>
        </div>
        <div class="floating-eunis-legend-content" id="eunis-legend-content">
            <div class="eunis-legend-loading">Loading legend...</div>
        </div>
    </div>

    <!-- BBT Data Popup Modal -->
    <div class="bbt-popup-overlay" id="bbt-popup-overlay">
        <div class="bbt-popup">
            <div class="bbt-popup-header">
                <h2 class="bbt-popup-title" id="bbt-popup-title">BBT Data</h2>
                <button class="bbt-popup-close" onclick="closeBBTDataPopup()">√ó</button>
            </div>
            <div class="bbt-popup-content" id="bbt-popup-content">
                <!-- Dynamic content populated by JavaScript -->
            </div>
            <div class="bbt-popup-actions">
                <button class="bbt-popup-btn bbt-popup-btn-cancel" onclick="closeBBTDataPopup()">Cancel</button>
                <button class="bbt-popup-btn bbt-popup-btn-save" onclick="saveBBTData()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Version Information Modal -->
    <div class="version-modal" id="versionModal" style="display: none;">
        <div class="version-modal-overlay" onclick="closeVersionInfo()"></div>
        <div class="version-modal-content">
            <div class="version-modal-header">
                <h2>About MARBEFES BBT Database</h2>
                <button class="version-modal-close" onclick="closeVersionInfo()">&times;</button>
            </div>
            <div class="version-modal-body">
                <div class="version-section">
                    <h3>Version Information</h3>
                    <table class="version-table">
                        <tr>
                            <td><strong>Version:</strong></td>
                            <td>1.2.1</td>
                        </tr>
                        <tr>
                            <td><strong>Release Date:</strong></td>
                            <td>October 13, 2025</td>
                        </tr>
                        <tr>
                            <td><strong>Deployment:</strong></td>
                            <td><a href="http://laguna.ku.lt:5000" target="_blank">laguna.ku.lt:5000</a></td>
                        </tr>
                        <tr>
                            <td><strong>Status:</strong></td>
                            <td><span class="status-badge" id="app-status">Checking...</span></td>
                        </tr>
                    </table>
                </div>

                <div class="version-section">
                    <h3>What's New in v1.2.0</h3>
                    <ul class="version-features">
                        <li>üîí Enhanced security with localhost binding</li>
                        <li>‚ö° 86% faster factsheet API (memory caching)</li>
                        <li>üêç Python 3.12+ compatibility</li>
                        <li>üì¶ Updated Flask-Caching to 2.3.1</li>
                        <li>üåê Configured for laguna.ku.lt deployment</li>
                    </ul>
                </div>

                <div class="version-section">
                    <h3>Data Loaded</h3>
                    <ul class="version-features">
                        <li>üìä <span id="factsheet-count">10</span> BBT Factsheets</li>
                        <li>üìà <span id="bathymetry-count">11</span> Bathymetry Statistics</li>
                        <li>üó∫Ô∏è <span id="vector-count">1</span> Vector Layer (<span id="feature-count">11</span> features)</li>
                        <li>üåä <span id="wms-count">265</span> EMODnet WMS Layers</li>
                        <li>üá™üá∫ <span id="helcom-count">218</span> HELCOM Layers</li>
                    </ul>
                </div>

                <div class="version-section">
                    <h3>Quick Help</h3>
                    <ul class="version-features">
                        <li>üñ±Ô∏è <strong>Pan:</strong> Click and drag the map</li>
                        <li>üîç <strong>Zoom:</strong> Use mouse wheel or +/- buttons</li>
                        <li>üéØ <strong>BBT Navigation:</strong> Click BBT buttons to zoom to areas</li>
                        <li>üìä <strong>Data:</strong> Click üìä button to view/edit BBT information</li>
                        <li>üó∫Ô∏è <strong>Layers:</strong> Toggle layers in the control panel</li>
                        <li>‚ÑπÔ∏è <strong>Info:</strong> Click on map features for details</li>
                    </ul>
                </div>

                <div class="version-section version-footer">
                    <p><strong>MARBEFES</strong> - Marine Biodiversity and Ecosystem Functioning leading to Ecosystem Services</p>
                    <p>Horizon Europe Project | <a href="https://github.com/anthropics/claude-code" target="_blank">Built with Claude Code</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Injection (Flask template variables) -->
    <script>
        // Inject Flask configuration into AppConfig
        window.AppConfig = window.AppConfig || {};
        window.AppConfig.API_BASE_URL = '{{ API_BASE_URL }}';
        window.AppConfig.WMS_BASE_URL = '{{ WMS_BASE_URL }}';
        window.AppConfig.HELCOM_WMS_BASE_URL = '{{ HELCOM_WMS_BASE_URL }}';

        // Inject layer data from Flask template
        window.wmsLayers = {{ layers | tojson }};
        window.helcomLayers = {{ helcom_layers | tojson }};
        window.vectorLayers = {{ vector_layers | tojson }};

        console.log('üìä Template data injected:');
        console.log('  - WMS layers:', window.wmsLayers ? window.wmsLayers.length : 0);
        console.log('  - HELCOM layers:', window.helcomLayers ? window.helcomLayers.length : 0);
        console.log('  - Vector layers:', window.vectorLayers ? window.vectorLayers.length : 0);
    </script>

    <!-- Application JavaScript Modules (loaded in correct dependency order) -->
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>
    <script src="{{ url_for('static', filename='js/map-init.js') }}"></script>
    <script src="{{ url_for('static', filename='js/layer-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bbt-tool.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ui-handlers.js') }}"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

    <!-- Version Info Modal Functions -->
    <script>
        function showVersionInfo() {
            const modal = document.getElementById('versionModal');
            modal.style.display = 'block';

            // Fetch health check to get real-time status
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    const statusBadge = document.getElementById('app-status');
                    if (data.status === 'healthy') {
                        statusBadge.textContent = '‚úÖ Operational';
                        statusBadge.className = 'status-badge status-healthy';
                    } else {
                        statusBadge.textContent = '‚ö†Ô∏è ' + data.status;
                        statusBadge.className = 'status-badge status-degraded';
                    }
                })
                .catch(error => {
                    const statusBadge = document.getElementById('app-status');
                    statusBadge.textContent = '‚ùå Error';
                    statusBadge.className = 'status-badge status-error';
                });
        }

        function closeVersionInfo() {
            const modal = document.getElementById('versionModal');
            modal.style.display = 'none';
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeVersionInfo();
            }
        });
    </script>

    <!-- EUNIS Legend Functions -->
    <script>
        // EUNIS Legend Control
        const EUNIS_LAYER_NAME = 'eusm_2023_eunis2019_full';

        function toggleEunisLegend() {
            const checkbox = document.getElementById('eunis-legend-toggle');
            const legend = document.getElementById('floating-eunis-legend');

            if (checkbox.checked) {
                showEunisLegend();
            } else {
                hideEunisLegend();
            }
        }

        function showEunisLegend() {
            const legend = document.getElementById('floating-eunis-legend');
            const content = document.getElementById('eunis-legend-content');

            // Show the legend container
            legend.classList.add('visible');

            // Load legend image if not already loaded
            if (content.querySelector('img') === null) {
                loadEunisLegendImage();
            }
        }

        function hideEunisLegend() {
            const legend = document.getElementById('floating-eunis-legend');
            legend.classList.remove('visible');
        }

        function closeEunisLegend() {
            const checkbox = document.getElementById('eunis-legend-toggle');
            checkbox.checked = false;
            hideEunisLegend();
        }

        function loadEunisLegendImage() {
            const content = document.getElementById('eunis-legend-content');
            const wmsUrl = window.AppConfig.WMS_BASE_URL || 'https://ows.emodnet-seabedhabitats.eu/geoserver/emodnet_view/wms';

            // Build GetLegendGraphic URL for EUNIS 2019 layer
            const legendUrl = `${wmsUrl}?SERVICE=WMS&VERSION=1.1.0&REQUEST=GetLegendGraphic&FORMAT=image/png&LAYER=${EUNIS_LAYER_NAME}&LEGEND_OPTIONS=fontAntiAliasing:true;fontSize:11;dpi:96`;

            // Create image element
            const img = document.createElement('img');
            img.src = legendUrl;
            img.alt = 'EUNIS 2019 Legend';
            img.style.width = '100%';

            // Handle load success
            img.onload = function() {
                content.innerHTML = '';
                content.appendChild(img);
            };

            // Handle load error
            img.onerror = function() {
                content.innerHTML = '<div class="eunis-legend-error">‚ùå Failed to load legend. Please check your connection.</div>';
            };

            // Show loading state
            content.innerHTML = '<div class="eunis-legend-loading">‚è≥ Loading EUNIS 2019 legend...</div>';
        }

        // Make legend draggable
        function makeLegendDraggable() {
            const legend = document.getElementById('floating-eunis-legend');
            const header = legend.querySelector('.floating-eunis-legend-header');

            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            header.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);

            // Touch support for mobile
            header.addEventListener('touchstart', dragStart);
            document.addEventListener('touchmove', drag);
            document.addEventListener('touchend', dragEnd);

            function dragStart(e) {
                // Don't drag if clicking on close button
                if (e.target.closest('.floating-eunis-legend-close')) {
                    return;
                }

                if (e.type === 'touchstart') {
                    initialX = e.touches[0].clientX - xOffset;
                    initialY = e.touches[0].clientY - yOffset;
                } else {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                }

                if (e.target === header || e.target.closest('.floating-eunis-legend-header')) {
                    isDragging = true;
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();

                    if (e.type === 'touchmove') {
                        currentX = e.touches[0].clientX - initialX;
                        currentY = e.touches[0].clientY - initialY;
                    } else {
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;
                    }

                    xOffset = currentX;
                    yOffset = currentY;

                    setTranslate(currentX, currentY, legend);
                }
            }

            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
            }

            function setTranslate(xPos, yPos, el) {
                el.style.transform = `translate(${xPos}px, ${yPos}px)`;
            }
        }

        // Attach event listener to checkbox
        document.addEventListener('DOMContentLoaded', function() {
            const checkbox = document.getElementById('eunis-legend-toggle');
            if (checkbox) {
                checkbox.addEventListener('change', toggleEunisLegend);
            }

            // Initialize drag functionality
            makeLegendDraggable();
        });
    </script>
</body>
</html>
