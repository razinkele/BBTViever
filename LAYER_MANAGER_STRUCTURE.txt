LAYER MANAGER MODULE - CODE STRUCTURE
======================================

File: /home/razinka/OneDrive/HORIZON_EUROPE/MARBEFES/EMODNET_PyDeck/static/js/layer-manager.js
Size: 1,208 lines (47 KB)

Line Range | Section
-----------|----------------------------------------------------------
1-11       | Module Header & JSDoc Documentation
12-15      | IIFE Start & 'use strict'
16-19      | PRIVATE VARIABLES Section Header
20-35      | Private State Variables (map, layers, flags, cache)
36-121     | BBT Region Information (MARBEFES project metadata)
122-170    | INITIALIZATION Section
           | - init() function
           | - setupMapEventHandlers() function
171-305    | TOOLTIP FUNCTIONS Section
           | - calculateFeatureArea()
           | - createTooltip()
           | - removeTooltip()
           | - updateTooltip()
           | - generateTooltipContent()
306-452    | ZOOM & EXTENT FUNCTIONS Section
           | - scaleToZoom()
           | - calculateOptimalZoom()
           | - zoomToLayerExtent()
453-582    | GETFEATUREINFO FUNCTIONS Section
           | - setupGetFeatureInfo()
           | - handleMapClick()
           | - buildGetFeatureInfoUrl()
           | - displayFeatureInfo()
583-782    | WMS LAYER MANAGEMENT Section
           | - updateWMSLayer()
           | - checkLayerVisibility()
           | - updateLegend()
           | - selectWMSLayerAsOverlay()
           | - getOptimalEUSeaMapLayer()
           | - switchEUSeaMapLayerByZoom()
783-817    | HELCOM LAYER MANAGEMENT Section
           | - selectHELCOMLayerAsOverlay()
818-1082   | VECTOR LAYER MANAGEMENT Section
           | - loadVectorLayer()
           | - loadVectorLayerFast()
           | - processVectorLayerData()
           | - loadMultipleLayersConcurrently()
           | - preloadLayersInBackground()
1083-1152  | UTILITY FUNCTIONS Section
           | - updateStatus()
           | - setOpacity()
           | - clearLayers()
1153-1207  | PUBLIC API Section
           | - Initialization functions
           | - WMS layer functions
           | - HELCOM layer functions
           | - Vector layer functions
           | - Extent/Zoom functions
           | - GetFeatureInfo functions
           | - Tooltip functions
           | - Utility functions
           | - Getter functions
1208       | IIFE Close

FUNCTIONAL CATEGORIES
=====================

1. INITIALIZATION (2 functions)
   - Map and layer group setup
   - Event handler registration

2. TOOLTIP MANAGEMENT (5 functions)
   - Area calculations with Leaflet.GeometryUtil
   - Dynamic tooltip creation/positioning
   - Enhanced MARBEFES content generation

3. ZOOM & EXTENT (3 functions)
   - Scale-to-zoom conversions
   - Optimal zoom calculations
   - WMS extent-based zooming

4. GETFEATUREINFO (4 functions)
   - WMS GetFeatureInfo protocol
   - Click event handling
   - Popup display

5. WMS LAYER MANAGEMENT (6 functions)
   - Layer loading and updates
   - Visibility checking
   - Legend management
   - Automatic zoom-based switching

6. HELCOM LAYER MANAGEMENT (1 function)
   - HELCOM WMS overlay support

7. VECTOR LAYER MANAGEMENT (5 functions)
   - GeoJSON loading with simplification
   - Layer caching (simplification-aware)
   - Concurrent loading
   - Background preloading

8. UTILITY (3 functions)
   - Status updates
   - Opacity control
   - Layer clearing

PUBLIC API: 28 FUNCTIONS
========================

Category          | Count | Functions
------------------|-------|------------------------------------------
Initialization    | 1     | init
WMS Management    | 4     | updateWMSLayer, selectWMSLayerAsOverlay,
                  |       | checkLayerVisibility, updateLegend
HELCOM            | 1     | selectHELCOMLayerAsOverlay
Vector Management | 3     | loadVectorLayer, loadVectorLayerFast,
                  |       | preloadLayersInBackground
Zoom & Extent     | 3     | zoomToLayerExtent, scaleToZoom,
                  |       | calculateOptimalZoom
GetFeatureInfo    | 4     | setupGetFeatureInfo, handleMapClick,
                  |       | buildGetFeatureInfoUrl, displayFeatureInfo
Tooltips          | 5     | createTooltip, removeTooltip, updateTooltip,
                  |       | generateTooltipContent, calculateFeatureArea
Utilities         | 3     | setOpacity, clearLayers, updateStatus
Getters           | 6     | getCurrentLayer, getCurrentLayerType,
                  |       | getWMSLayer, getHELCOMLayer,
                  |       | getVectorLayerGroup, getLayerCache

DEPENDENCIES
============

External:
  - Leaflet 1.9.4+ (required)
  - Leaflet.GeometryUtil (optional, for accurate area calculations)

Internal:
  - window.AppConfig (config.js)
    * API_BASE_URL
    * WMS_BASE_URL
    * HELCOM_WMS_BASE_URL
  - window.MapInit.getMap() (map-init.js)

KEY FEATURES
============

✓ Simplification-aware vector loading (800m @ zoom < 8)
✓ Layer caching with simplification state
✓ Automatic EUNIS layer switching by zoom
✓ Concurrent layer loading (3 parallel requests)
✓ Background preloading for instant access
✓ WMS GetFeatureInfo support
✓ Scale-aware zoom calculations
✓ Enhanced BBT tooltips with MARBEFES context
✓ Comprehensive error handling
✓ Debounced zoom events (300ms)
✓ Timeout protection (15-20s)

PERFORMANCE OPTIMIZATIONS
==========================

1. Geometry Simplification - 90% size reduction for overview maps
2. Layer Caching - Instant layer switching
3. Concurrent Loading - Parallel API requests
4. Debounced Events - Prevents excessive operations
5. Abort Controllers - Prevents hanging requests
6. Lazy Loading - Only loads when needed
7. Memory Management - Proper cleanup and cache limits

CODE QUALITY
============

✓ Strict mode enabled
✓ Module pattern (IIFE + revealing module)
✓ JSDoc comments throughout
✓ Consistent naming conventions
✓ Defensive programming (null checks)
✓ Error handling with user feedback
✓ Clear separation of concerns
✓ DRY principle applied
✓ No global pollution (single window.LayerManager)

BROWSER COMPATIBILITY
=====================

✓ Chrome 90+
✓ Firefox 88+
✓ Safari 14+
✓ Edge 90+
✗ IE11 (ES6+ features used)

RELATED FILES
=============

JavaScript Modules:
  /static/js/config.js          - Configuration and constants
  /static/js/map-init.js        - Map initialization
  /static/js/layer-manager.js   - Layer management (THIS FILE)
  /static/js/bbt-tool.js        - BBT bathymetry tool

Documentation:
  /LAYER_MANAGER_MODULE.md      - Comprehensive documentation
  /LAYER_MANAGER_QUICK_REFERENCE.md - Quick reference guide
  /LAYER_MANAGER_STRUCTURE.txt  - This file

Original Source:
  /templates/index.html (lines 1027-2600) - Extracted from this file

